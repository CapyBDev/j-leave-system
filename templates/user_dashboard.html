{% extends "base.html" %}
{% block title %}Dashboard | J-Leave{% endblock %}
{% block content %}

<!-- ========================= -->
<!-- ðŸŸ¢ WELCOME / QUICK ACTION -->
<!-- ========================= -->
<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card glass-card">
      <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <h4 class="mb-2">
            <i class="bi bi-emoji-smile"></i>
            Welcome, {{ session.get('full_name') }}!
          </h4>
          <p class="mb-1">Quick actions</p>

          <a class="btn btn-primary me-2 mb-2" href="{{ url_for('apply_leave') }}">
            <i class="bi bi-file-earmark-plus"></i> Apply Leave
          </a>

          <a class="btn btn-outline-light mb-2" href="{{ url_for('calendar') }}">
            <i class="bi bi-calendar3"></i> View Calendar
          </a>
        </div>

        {% if my_leaves and my_leaves[0].status in ['Approved', 'Rejected'] %}
        <span class="badge bg-warning text-dark align-self-start">
          <i class="bi bi-bell"></i> New Update
        </span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- ðŸ©º MC + MY LEAVES -->
<!-- ========================= -->
<div class="row g-3">

  <!-- ========================= -->
  <!-- ðŸ©º MEDICAL CERTIFICATE -->
  <!-- ========================= -->
  <div class="col-lg-8">
    <div class="card glass-card h-100">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">
            <i class="bi bi-file-earmark-medical text-danger"></i>
            Medical Certificate
          </h4>

          <button class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="collapse"
                  data-bs-target="#uploadMCForm">
            <i class="bi bi-upload"></i> Upload MC
          </button>
        </div>

        <!-- Upload MC -->
        <div class="collapse mb-3" id="uploadMCForm">
          <form method="POST"
                action="{{ url_for('user_upload_mc') }}"
                enctype="multipart/form-data">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">MC Number</label>
                <input type="text" name="mc_number" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" name="mc_start" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" name="mc_end" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">MC File</label>
                <input type="file" name="mc_file" class="form-control" required>
              </div>
            </div>

            <div class="text-end mt-3">
              <button class="btn btn-danger btn-sm">
                <i class="bi bi-check-circle"></i> Submit MC
              </button>
            </div>
          </form>
        </div>

        <!-- MC LIST -->
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>MC No.</th>
                <th>Period</th>
                <th>Uploaded</th>
                <th>Document</th>
              </tr>
            </thead>
            <tbody>
              {% for mc in my_mc %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ mc.mc_number or '-' }}</td>
                <td>{{ mc.start_date or '-' }} â†’ {{ mc.end_date or '-' }}</td>
                <td><small class="text-muted">{{ mc.created_at[:10] }}</small></td>
                <td>
                  {% if mc.pdf_path %}
                  <a href="{{ url_for('leave_docs', filename=mc.pdf_path) }}"
                     target="_blank"
                     class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-file-earmark-pdf"></i> View
                  </a>
                  {% else %}-{% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted">
                  No MC uploaded
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- ðŸŸ¢ MY RECENT LEAVES -->
  <!-- ========================= -->
  <div class="col-lg-4">
    <div class="card glass-card h-100">
      <div class="card-body">
        <h5 class="mb-3">
          <i class="bi bi-list-check"></i>
          My Recent Leaves
        </h5>

        {% if my_leaves and my_leaves[0].status in ['Approved', 'Rejected'] %}
        <div class="alert {% if my_leaves[0].status == 'Approved' %}alert-success{% else %}alert-danger{% endif %}">
          <i class="bi bi-bell-fill"></i>
          Last request: <strong>{{ my_leaves[0].status }}</strong>
        </div>
        {% endif %}

        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Type</th>
                <th>Period</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for l in my_leaves %}
              <tr>
                <td>{{ l.leave_type }}</td>
                <td><small>{{ l.start_date }} â†’ {{ l.end_date }}</small></td>
                <td>
                  <span class="badge 
                    {% if l.status=='Approved' %}bg-success
                    {% elif l.status=='Rejected' %}bg-danger
                    {% else %}bg-warning text-dark{% endif %}">
                    {{ l.status }}
                  </span>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-muted text-center">No leave records</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- ========================= -->
<!-- ðŸ”” ROLE BASED ACTIONS -->
<!-- ========================= -->
{% if (my_pos and my_pos.startswith("DEPUTY GENERAL MANAGER")) or
      (my_pos and my_pos.startswith("GENERAL MANAGER")) or
      (my_pos and my_pos.startswith("CEO")) %}

<div class="card glass-card mt-4">
  <div class="card-body">
    <h5 class="mb-3">
      <i class="bi bi-exclamation-circle"></i>
      Pending Actions
    </h5>

    {% for l in to_check + to_approve %}
      <p>
        <strong>{{ l.full_name }}</strong> â€” {{ l.leave_type }}
        <span class="badge bg-warning ms-2">{{ l.status }}</span>
      </p>
      <a href="{{ url_for('leave_details', leave_id=l.id) }}"
         class="btn btn-primary btn-sm mb-3">
        <i class="bi bi-eye"></i> View Leave
      </a>
      <hr>
    {% else %}
      <p class="text-muted">No pending actions.</p>
    {% endfor %}
  </div>
</div>

{% endif %}

<!-- ========================= -->
<!-- ðŸ”” SUMMARY NOTIFICATION -->
<!-- ========================= -->
{% if total_pending > 0 %}
<div class="alert alert-info mt-4">
  <i class="bi bi-bell"></i>
  You have <strong>{{ total_pending }}</strong> pending actions
</div>
{% endif %}

{% endblock %}
